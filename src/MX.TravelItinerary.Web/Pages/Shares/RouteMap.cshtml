@page "/shares/{tripSlug}/{shareCode}/route"
@model MX.TravelItinerary.Web.Pages.Shares.ShareRouteMapModel
@{
    ViewData["Title"] = "Shared route map";
    var trip = Model.TripDetails?.Trip;
    var heading = !string.IsNullOrWhiteSpace(trip?.Name) ? trip!.Name : "Trip route";
}

<div class="py-4">
    <div class="container-small">
        <div class="d-flex flex-column flex-lg-row gap-3 justify-content-between align-items-start align-items-lg-center mb-4">
            <div>
                <p class="text-uppercase small text-muted mb-1">Shared route</p>
                <h1 class="mb-1">@heading</h1>
                <div class="text-muted">
                    @if (trip?.StartDate is not null || trip?.EndDate is not null)
                    {
                        <span>@trip?.StartDate?.ToString("MMM dd, yyyy")</span>
                        @if (trip?.EndDate is not null)
                        {
                            <text> – @trip?.EndDate?.ToString("MMM dd, yyyy")</text>
                        }
                    }
                    else
                    {
                        <span>Dates coming soon</span>
                    }
                </div>
            </div>
            <div class="d-flex flex-wrap gap-2 justify-content-end align-self-start align-self-lg-center">
                <a class="btn btn-outline-primary"
                   asp-page="/Shares/View"
                   asp-route-tripSlug="@Model.TripSlug"
                   asp-route-shareCode="@Model.ShareCode">
                    Timeline view
                </a>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
        {
            <div class="alert alert-warning">@Model.ErrorMessage</div>
        }
        else if (Model.TripDetails is null)
        {
            <div class="alert alert-warning">This itinerary could not be found.</div>
        }
        else if (!Model.HasRoutePoints)
        {
            <div class="alert alert-info">Add Google-linked locations or travel segments to the shared itinerary to plot the route.</div>
        }
        else
        {
            <div class="route-map-card">
                @if (Model.IsGoogleMapsConfigured)
                {
                    <div class="route-map-viewport" data-route-map data-route-source="route-map-data">
                        <div class="route-map-loading" data-route-map-loading>
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading map...</span>
                            </div>
                            <div>Loading map...</div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="route-map-viewport route-map-viewport--disabled">
                        <div class="route-map-placeholder">
                            The trip owner must configure a Google Maps API key for this map to render.
                        </div>
                    </div>
                }

                <div class="route-stop-panel">
                    <div class="route-stop-panel-header">
                        <div class="text-uppercase text-muted small">Stops</div>
                        <h5 class="mb-0">Route sequence</h5>
                    </div>
                    <ol class="route-stop-list" data-route-stop-list>
                        @foreach (var stop in Model.RoutePoints)
                        {
                            <li class="route-stop" data-route-stop-id="@stop.StopId" tabindex="0" role="button">
                                <div class="route-stop-sequence">@stop.Sequence</div>
                                <div class="route-stop-body">
                                    <div class="route-stop-label">@stop.StopLabel</div>
                                    <div class="route-stop-meta">@stop.StopType · @stop.EntryTypeLabel</div>
                                    @if (!string.IsNullOrWhiteSpace(stop.DateLabel))
                                    {
                                        <div class="route-stop-date">@stop.DateLabel</div>
                                    }
                                </div>
                            </li>
                        }
                    </ol>
                </div>
            </div>

            @if (Model.IsGoogleMapsConfigured)
            {
                <script type="application/json" id="route-map-data">
                    @Html.Raw(Model.GetSerializedRoutePoints())
                </script>
            }
        }
    </div>
</div>

@section Scripts {
    @if (Model.IsGoogleMapsConfigured && Model.HasRoutePoints)
    {
        <script>
            window.travelRouteMapReady = function () {
                document.dispatchEvent(new CustomEvent('travel-route-map:loader-ready'));
            };
        </script>
        <script async defer
                src="https://maps.googleapis.com/maps/api/js?key=@Model.GoogleMapsApiKey&libraries=places&callback=travelRouteMapReady"></script>
    }
}
