@page "{tripId}"
@model MX.TravelItinerary.Web.Pages.Trips.DetailsModel
@using System.Linq
@{
    ViewData["Title"] = "Trip Timeline";
    var trip = Model.TripDetails?.Trip;
}

<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <div>
        <p class="text-uppercase text-muted small mb-1">Trip Timeline</p>
        <h1 class="mb-1">@trip?.Name</h1>
        <div class="text-muted">
            @if (trip?.StartDate is not null || trip?.EndDate is not null)
            {
                <span>@trip?.StartDate?.ToString("MMM dd, yyyy")</span>
                {
                    <span> – @trip?.EndDate?.ToString("MMM dd, yyyy")</span>
                }
            }
            else
            {
                <span>Dates coming soon</span>
            }
        </div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" asp-page="./Index">Back to Trips</a>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
{
    <div class="alert alert-success" role="alert">
        @Model.StatusMessage
    </div>
}

@if (Model.TripDetails is null)
{
    <div class="alert alert-warning">Trip could not be loaded.</div>
}
else
{
    var hasPlannedContent = Model.Timeline.Segments.Any()
    || Model.Timeline.UnscheduledSegments.Any()
    || Model.Timeline.Days.Any(day => day.Entries.Count > 0);
    if (!hasPlannedContent)
    {
        <div class="alert alert-info">No itinerary entries yet. Use the quick actions to start planning this trip.</div>
    }

    @if (Model.Timeline.UnscheduledSegments.Count > 0)
    {
        <div class="timeline-unscheduled card mb-4">
            <div class="card-body">
                <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                    <div>
                        <p class="text-uppercase text-muted small mb-1">Needs schedule</p>
                        <h2 class="h5 mb-0">Unscheduled segments</h2>
                    </div>
                    <p class="text-muted small mb-0">Add start or end times to place these segments on the main timeline.</p>
                </div>
                <div class="timeline-unscheduled-list mt-3">
                    @foreach (var segment in Model.Timeline.UnscheduledSegments)
                    {
                        var unscheduledBooking = Model.GetBookingForSegment(segment.SegmentId);
                        <div class="timeline-item timeline-item--segment" data-timeline-item data-item-type="segment"
                            data-item-id="@segment.SegmentId">
                            <div class="timeline-item-body">
                                <span>@segment</span>
                                @if (unscheduledBooking is not null)
                                {
                                    <span class="booking-indicator" title="Booking attached">&#128206;</span>
                                }
                                <div class="small text-muted">No dates provided</div>
                            </div>
                            <div class="timeline-actions">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" data-edit-type="segment"
                                    data-segment-id="@segment.SegmentId"
                                    data-segment-title="@(segment.Title ?? segment.SegmentType.GetDisplayName())"
                                    data-segment-type="@segment.SegmentType" data-segment-start="" data-segment-end=""
                                    data-segment-description="@(segment.Description ?? string.Empty)">
                                    Edit
                                </button>
                                <form method="post" asp-page-handler="DeleteSegment" class="d-inline">
                                    <input type="hidden" name="segmentId" value="@segment.SegmentId" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                                @if (unscheduledBooking is null)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="add"
                                        data-parent-type="segment" data-segment-id="@segment.SegmentId"
                                        data-segment-title="@(segment.Title ?? segment.SegmentType.GetDisplayName())">
                                        Add booking
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="view"
                                        data-booking-id="@unscheduledBooking.BookingId"
                                        data-booking-type="@unscheduledBooking.BookingType"
                                        data-booking-type-label="@unscheduledBooking.BookingType.GetDisplayName()"
                                        data-booking-vendor="@(unscheduledBooking.Vendor ?? string.Empty)"
                                        data-booking-reference="@(unscheduledBooking.Reference ?? string.Empty)"
                                        data-booking-cost="@(unscheduledBooking.Cost?.ToString("0.##") ?? string.Empty)"
                                        data-booking-currency="@(unscheduledBooking.Currency ?? string.Empty)"
                                        data-booking-refundable="@(unscheduledBooking.IsRefundable?.ToString().ToLowerInvariant() ?? string.Empty)"
                                        data-booking-cancellation="@(unscheduledBooking.CancellationPolicy ?? string.Empty)"
                                        data-booking-details="@(unscheduledBooking.ConfirmationDetailsJson ?? string.Empty)"
                                        data-booking-parent-label="@segment" data-booking-parent-type="segment"
                                        data-parent-segment="@segment.SegmentId">
                                        View booking
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <div class="timeline-grid">
        @foreach (var day in Model.Timeline.Days)
        {
            <div class="timeline-axis" style="grid-row:@day.RowLine;">
                <div class="timeline-axis-dot"></div>
                <div>
                    <div class="timeline-day-label">@day.Date.ToString("MMM dd")</div>
                    <div class="timeline-day-weekday">@day.Date.ToString("dddd")</div>
                </div>
            </div>
            <div class="timeline-content" style="grid-row:@day.RowLine;">
                @if (day.Entries.Count == 0)
                {
                    <div class="timeline-empty text-muted">No entries for this day.</div>
                }
                else
                {
                    @foreach (var entry in day.Entries)
                    {
                        var entryBooking = Model.GetBookingForEntry(entry.EntryId);
                        <div class="timeline-item" data-timeline-item data-item-type="entry" data-item-id="@entry.EntryId">
                            <div class="timeline-item-body">
                                <span>@entry</span>
                                @if (entryBooking is not null)
                                {
                                    <span class="booking-indicator" title="Booking attached">&#128206;</span>
                                }
                            </div>
                            <div class="timeline-actions">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" data-edit-type="entry"
                                    data-entry-id="@entry.EntryId" data-entry-title="@entry.Title"
                                    data-entry-date="@(entry.Date?.ToString("yyyy-MM-dd") ?? string.Empty)"
                                    data-entry-category="@(entry.Category?.ToString() ?? string.Empty)"
                                    data-entry-details="@(entry.Details ?? string.Empty)">
                                    Edit
                                </button>
                                <form method="post" asp-page-handler="DeleteEntry" class="d-inline">
                                    <input type="hidden" name="entryId" value="@entry.EntryId" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                                @if (entryBooking is null)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="add"
                                        data-parent-type="entry" data-entry-id="@entry.EntryId" data-entry-title="@entry.Title">
                                        Add booking
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="view"
                                        data-booking-id="@entryBooking.BookingId" data-booking-type="@entryBooking.BookingType"
                                        data-booking-type-label="@entryBooking.BookingType.GetDisplayName()"
                                        data-booking-vendor="@(entryBooking.Vendor ?? string.Empty)"
                                        data-booking-reference="@(entryBooking.Reference ?? string.Empty)"
                                        data-booking-cost="@(entryBooking.Cost?.ToString("0.##") ?? string.Empty)"
                                        data-booking-currency="@(entryBooking.Currency ?? string.Empty)"
                                        data-booking-refundable="@(entryBooking.IsRefundable?.ToString().ToLowerInvariant() ?? string.Empty)"
                                        data-booking-cancellation="@(entryBooking.CancellationPolicy ?? string.Empty)"
                                        data-booking-details="@(entryBooking.ConfirmationDetailsJson ?? string.Empty)"
                                        data-booking-parent-label="@entry" data-booking-parent-type="entry"
                                        data-parent-entry="@entry.EntryId">
                                        View booking
                                    </button>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        }

        @foreach (var block in Model.Timeline.Segments)
        {
            var segmentType = block.Segment.SegmentType.ToCssToken();
            var segmentBooking = Model.GetBookingForSegment(block.Segment.SegmentId);
            <div class="timeline-segment"
                style="grid-row:@block.RowStart / @block.RowEnd; --lane-index:@block.LaneIndex; --lane-count:@block.LaneCount;"
                data-segment-type="@segmentType">
                <div class="timeline-segment-span" aria-hidden="true"></div>
                <div class="timeline-item timeline-item--segment segment-type-@segmentType" data-timeline-item
                    data-item-type="segment" data-item-id="@block.Segment.SegmentId">
                    <div class="timeline-item-body">
                        <span>@block.Segment</span>
                        @if (segmentBooking is not null)
                        {
                            <span class="booking-indicator" title="Booking attached">&#128206;</span>
                        }
                        <div class="small text-muted">@block.StartDate.ToString("MMM dd") – @block.EndDate.ToString("MMM dd")
                        </div>
                    </div>
                    <div class="timeline-actions">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" data-edit-type="segment"
                            data-segment-id="@block.Segment.SegmentId"
                            data-segment-title="@(block.Segment.Title ?? block.Segment.SegmentType.GetDisplayName())"
                            data-segment-type="@block.Segment.SegmentType"
                            data-segment-start="@(block.Segment.StartDateTimeUtc?.ToLocalTime().ToString("yyyy-MM-ddTHH:mm") ?? string.Empty)"
                            data-segment-end="@(block.Segment.EndDateTimeUtc?.ToLocalTime().ToString("yyyy-MM-ddTHH:mm") ?? string.Empty)"
                            data-segment-description="@(block.Segment.Description ?? string.Empty)">
                            Edit
                        </button>
                        <form method="post" asp-page-handler="DeleteSegment" class="d-inline">
                            <input type="hidden" name="segmentId" value="@block.Segment.SegmentId" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                        @if (segmentBooking is null)
                        {
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="add"
                                data-parent-type="segment" data-segment-id="@block.Segment.SegmentId"
                                data-segment-title="@(block.Segment.Title ?? block.Segment.SegmentType.GetDisplayName())">
                                Add booking
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="view"
                                data-booking-id="@segmentBooking.BookingId" data-booking-type="@segmentBooking.BookingType"
                                data-booking-type-label="@segmentBooking.BookingType.GetDisplayName()"
                                data-booking-vendor="@(segmentBooking.Vendor ?? string.Empty)"
                                data-booking-reference="@(segmentBooking.Reference ?? string.Empty)"
                                data-booking-cost="@(segmentBooking.Cost?.ToString("0.##") ?? string.Empty)"
                                data-booking-currency="@(segmentBooking.Currency ?? string.Empty)"
                                data-booking-refundable="@(segmentBooking.IsRefundable?.ToString().ToLowerInvariant() ?? string.Empty)"
                                data-booking-cancellation="@(segmentBooking.CancellationPolicy ?? string.Empty)"
                                data-booking-details="@(segmentBooking.ConfirmationDetailsJson ?? string.Empty)"
                                data-booking-parent-label="@block.Segment" data-booking-parent-type="segment"
                                data-parent-segment="@block.Segment.SegmentId">
                                View booking
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

<div class="fab-container" data-fab>
    <button type="button" class="btn btn-primary rounded-circle fab-main" aria-label="Quick add" data-fab-toggle>
        <span class="fab-icon">+</span>
    </button>
    <div class="fab-menu">
        <button type="button" class="fab-option" data-open-form="segment">Add trip segment</button>
        <button type="button" class="fab-option" data-open-form="entry">Add itinerary entry</button>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="segmentFlyout" aria-labelledby="segmentFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="segmentFlyoutLabel" class="offcanvas-title">Add trip segment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form method="post" asp-page-handler="SaveSegment" id="segment-form">
            <input asp-for="SegmentInput.TripId" type="hidden" />
            <input asp-for="SegmentInput.SegmentId" type="hidden" />
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <div class="mb-3">
                <label asp-for="SegmentInput.Title" class="form-label"></label>
                <input asp-for="SegmentInput.Title" class="form-control" />
                <span asp-validation-for="SegmentInput.Title" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="SegmentInput.SegmentType" class="form-label"></label>
                <select asp-for="SegmentInput.SegmentType" class="form-select"
                    asp-items="Model.SegmentTypeOptions"></select>
                <span asp-validation-for="SegmentInput.SegmentType" class="text-danger"></span>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="SegmentInput.StartDateTimeUtc" class="form-label"></label>
                    <input asp-for="SegmentInput.StartDateTimeUtc" class="form-control" type="datetime-local"
                        asp-format="{0:yyyy-MM-ddTHH:mm}" />
                    <span asp-validation-for="SegmentInput.StartDateTimeUtc" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="SegmentInput.EndDateTimeUtc" class="form-label"></label>
                    <input asp-for="SegmentInput.EndDateTimeUtc" class="form-control" type="datetime-local"
                        asp-format="{0:yyyy-MM-ddTHH:mm}" />
                    <span asp-validation-for="SegmentInput.EndDateTimeUtc" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="SegmentInput.Description" class="form-label"></label>
                <textarea asp-for="SegmentInput.Description" class="form-control" rows="3"></textarea>
                <span asp-validation-for="SegmentInput.Description" class="text-danger"></span>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save segment</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="entryFlyout" aria-labelledby="entryFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="entryFlyoutLabel" class="offcanvas-title">Add itinerary entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form method="post" asp-page-handler="SaveEntry" id="entry-form">
            <input asp-for="EntryInput.TripId" type="hidden" />
            <input asp-for="EntryInput.EntryId" type="hidden" />
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <div class="mb-3">
                <label asp-for="EntryInput.Title" class="form-label"></label>
                <input asp-for="EntryInput.Title" class="form-control" />
                <span asp-validation-for="EntryInput.Title" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Date" class="form-label"></label>
                <input asp-for="EntryInput.Date" class="form-control" type="date" asp-format="{0:yyyy-MM-dd}" />
                <span asp-validation-for="EntryInput.Date" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Category" class="form-label"></label>
                <select asp-for="EntryInput.Category" class="form-select"
                    asp-items="Model.EntryCategoryOptions"></select>
                <span asp-validation-for="EntryInput.Category" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Details" class="form-label"></label>
                <textarea asp-for="EntryInput.Details" class="form-control" rows="4"></textarea>
                <span asp-validation-for="EntryInput.Details" class="text-danger"></span>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save entry</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="bookingFlyout" aria-labelledby="bookingFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="bookingFlyoutLabel" class="offcanvas-title">Add booking confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form method="post" asp-page-handler="SaveBooking" id="booking-form">
            <input asp-for="BookingInput.TripId" type="hidden" />
            <input asp-for="BookingInput.BookingId" type="hidden" />
            <input asp-for="BookingInput.EntryId" type="hidden" />
            <input asp-for="BookingInput.SegmentId" type="hidden" />
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <div class="mb-3">
                <label asp-for="BookingInput.BookingType" class="form-label"></label>
                <select asp-for="BookingInput.BookingType" class="form-select"
                    asp-items="Model.BookingTypeOptions"></select>
                <span asp-validation-for="BookingInput.BookingType" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.Vendor" class="form-label"></label>
                <input asp-for="BookingInput.Vendor" class="form-control" />
                <span asp-validation-for="BookingInput.Vendor" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.Reference" class="form-label"></label>
                <input asp-for="BookingInput.Reference" class="form-control" />
                <span asp-validation-for="BookingInput.Reference" class="text-danger"></span>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="BookingInput.Cost" class="form-label"></label>
                    <input asp-for="BookingInput.Cost" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="BookingInput.Cost" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="BookingInput.Currency" class="form-label"></label>
                    <input asp-for="BookingInput.Currency" class="form-control" maxlength="3"
                        style="text-transform:uppercase;" />
                    <span asp-validation-for="BookingInput.Currency" class="text-danger"></span>
                </div>
            </div>

            <div class="form-check mb-3 mt-2">
                <input asp-for="BookingInput.IsRefundable" class="form-check-input" type="checkbox" value="true" />
                <label asp-for="BookingInput.IsRefundable" class="form-check-label"></label>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.CancellationPolicy" class="form-label"></label>
                <textarea asp-for="BookingInput.CancellationPolicy" class="form-control" rows="2"></textarea>
                <span asp-validation-for="BookingInput.CancellationPolicy" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.ConfirmationDetails" class="form-label"></label>
                <textarea asp-for="BookingInput.ConfirmationDetails" class="form-control" rows="4"></textarea>
                <span asp-validation-for="BookingInput.ConfirmationDetails" class="text-danger"></span>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save booking</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="bookingDetailFlyout" aria-labelledby="bookingDetailFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="bookingDetailFlyoutLabel" class="offcanvas-title">Booking details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="mb-3">
            <div class="text-muted text-uppercase small">Linked to</div>
            <div class="fw-semibold" data-booking-detail="parent">—</div>
        </div>
        <dl class="row booking-detail-list">
            <dt class="col-sm-4">Type</dt>
            <dd class="col-sm-8" data-booking-detail="type">—</dd>
            <dt class="col-sm-4">Vendor</dt>
            <dd class="col-sm-8" data-booking-detail="vendor">—</dd>
            <dt class="col-sm-4">Confirmation #</dt>
            <dd class="col-sm-8" data-booking-detail="reference">—</dd>
            <dt class="col-sm-4">Cost</dt>
            <dd class="col-sm-8" data-booking-detail="cost">—</dd>
            <dt class="col-sm-4">Refundable</dt>
            <dd class="col-sm-8" data-booking-detail="refundable">—</dd>
            <dt class="col-sm-4">Cancellation</dt>
            <dd class="col-sm-8" data-booking-detail="cancellation">—</dd>
        </dl>
        <div class="mb-4">
            <div class="text-muted text-uppercase small">Confirmation details</div>
            <div class="booking-detail-notes" data-booking-detail="notes">—</div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-primary" id="bookingDetailEditButton">Edit booking</button>
            <form method="post" asp-page-handler="DeleteBooking" id="bookingDetailDeleteForm" class="d-inline">
                <input type="hidden" name="tripId" value="@Model.TripDetails?.Trip.TripId" />
                <input type="hidden" name="bookingId" value="" />
                <button type="submit" class="btn btn-outline-danger">Delete booking</button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}