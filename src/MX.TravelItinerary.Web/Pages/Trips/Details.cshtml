@page "{tripId}"
@model MX.TravelItinerary.Web.Pages.Trips.DetailsModel
@using System.Linq
@{
    ViewData["Title"] = "Trip Timeline";
    var trip = Model.TripDetails?.Trip;
}

<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <div>
        <p class="text-uppercase text-muted small mb-1">Trip Timeline</p>
        <h1 class="mb-1">@trip?.Name</h1>
        <div class="text-muted">
            @if (trip?.StartDate is not null || trip?.EndDate is not null)
            {
                <span>@trip?.StartDate?.ToString("MMM dd, yyyy")</span>
                @if (trip?.EndDate is not null)
                {
                    <span> – @trip.EndDate?.ToString("MMM dd, yyyy")</span>
                }
            }
            else
            {
                <span>Dates coming soon</span>
            }
        </div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" asp-page="./Index">Back to Trips</a>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
{
    <div class="alert alert-success" role="alert">
        @Model.StatusMessage
    </div>
}

@if (Model.TripDetails is null)
{
    <div class="alert alert-warning">Trip could not be loaded.</div>
}
else
{
    var hasPlannedContent = Model.Timeline.Segments.Any()
        || Model.Timeline.UnscheduledSegments.Any()
        || Model.Timeline.Days.Any(day => day.Entries.Count > 0);
    if (!hasPlannedContent)
    {
        <div class="alert alert-info">No itinerary entries yet. Use the quick actions to start planning this trip.</div>
    }

    @if (Model.Timeline.UnscheduledSegments.Count > 0)
    {
        <div class="timeline-unscheduled card mb-4">
            <div class="card-body">
                <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                    <div>
                        <p class="text-uppercase text-muted small mb-1">Needs schedule</p>
                        <h2 class="h5 mb-0">Unscheduled segments</h2>
                    </div>
                    <p class="text-muted small mb-0">Add start or end times to place these segments on the main timeline.</p>
                </div>
                <div class="timeline-unscheduled-list mt-3">
                    @foreach (var segment in Model.Timeline.UnscheduledSegments)
                    {
                        <div class="timeline-item timeline-item--segment" data-timeline-item data-item-type="segment" data-item-id="@segment.SegmentId">
                            <div class="timeline-item-body">
                                @segment
                                <div class="small text-muted">No dates provided</div>
                            </div>
                            <div class="timeline-actions">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2"
                                        data-edit-type="segment"
                                        data-segment-id="@segment.SegmentId"
                                        data-segment-title="@(segment.Title ?? string.Empty)"
                                        data-segment-type="@segment.SegmentType"
                                        data-segment-start=""
                                        data-segment-end=""
                                        data-segment-description="@(segment.Description ?? string.Empty)">
                                    Edit
                                </button>
                                <form method="post" asp-page-handler="DeleteSegment" class="d-inline">
                                    <input type="hidden" name="segmentId" value="@segment.SegmentId" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <div class="timeline-grid">
        @foreach (var day in Model.Timeline.Days)
        {
            <div class="timeline-axis" style="grid-row:@day.RowLine;">
                <div class="timeline-axis-dot"></div>
                <div>
                    <div class="timeline-day-label">@day.Date.ToString("MMM dd")</div>
                    <div class="timeline-day-weekday">@day.Date.ToString("dddd")</div>
                </div>
            </div>
            <div class="timeline-content" style="grid-row:@day.RowLine;">
                @if (day.Entries.Count == 0)
                {
                    <div class="timeline-empty text-muted">No entries for this day.</div>
                }
                else
                {
                    @foreach (var entry in day.Entries)
                    {
                        <div class="timeline-item" data-timeline-item data-item-type="entry" data-item-id="@entry.EntryId">
                            <div class="timeline-item-body">
                                @entry
                            </div>
                            <div class="timeline-actions">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2"
                                        data-edit-type="entry"
                                        data-entry-id="@entry.EntryId"
                                        data-entry-title="@entry.Title"
                                        data-entry-date="@(entry.Date?.ToString("yyyy-MM-dd") ?? string.Empty)"
                                        data-entry-category="@(entry.Category ?? string.Empty)"
                                        data-entry-details="@(entry.Details ?? string.Empty)">
                                    Edit
                                </button>
                                <form method="post" asp-page-handler="DeleteEntry" class="d-inline">
                                    <input type="hidden" name="entryId" value="@entry.EntryId" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            </div>
                        </div>
                    }
                }
            </div>
        }

        @foreach (var segment in Model.Timeline.Segments)
        {
            <div class="timeline-segment" style="grid-row:@segment.RowStart / @segment.RowEnd;">
                <div class="timeline-item timeline-item--segment" data-timeline-item data-item-type="segment" data-item-id="@segment.Segment.SegmentId">
                    <div class="timeline-item-body">
                        @segment.Segment
                        <div class="small text-muted">@segment.StartDate.ToString("MMM dd") – @segment.EndDate.ToString("MMM dd")</div>
                    </div>
                    <div class="timeline-actions">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2"
                                data-edit-type="segment"
                                data-segment-id="@segment.Segment.SegmentId"
                                data-segment-title="@(segment.Segment.Title ?? string.Empty)"
                                data-segment-type="@segment.Segment.SegmentType"
                                data-segment-start="@(segment.Segment.StartDateTimeUtc?.ToLocalTime().ToString("yyyy-MM-ddTHH:mm") ?? string.Empty)"
                                data-segment-end="@(segment.Segment.EndDateTimeUtc?.ToLocalTime().ToString("yyyy-MM-ddTHH:mm") ?? string.Empty)"
                                data-segment-description="@(segment.Segment.Description ?? string.Empty)">
                            Edit
                        </button>
                        <form method="post" asp-page-handler="DeleteSegment" class="d-inline">
                            <input type="hidden" name="segmentId" value="@segment.Segment.SegmentId" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
}

<div class="fab-container" data-fab>
    <button type="button" class="btn btn-primary rounded-circle fab-main" aria-label="Quick add" data-fab-toggle>
        <span class="fab-icon">+</span>
    </button>
    <div class="fab-menu">
        <button type="button" class="fab-option" data-open-form="segment">Add trip segment</button>
        <button type="button" class="fab-option" data-open-form="entry">Add itinerary entry</button>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="segmentFlyout" aria-labelledby="segmentFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="segmentFlyoutLabel" class="offcanvas-title">Add trip segment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form method="post" asp-page-handler="SaveSegment" id="segment-form">
            <input asp-for="SegmentInput.TripId" type="hidden" />
            <input asp-for="SegmentInput.SegmentId" type="hidden" />
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <div class="mb-3">
                <label asp-for="SegmentInput.Title" class="form-label"></label>
                <input asp-for="SegmentInput.Title" class="form-control" />
                <span asp-validation-for="SegmentInput.Title" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="SegmentInput.SegmentType" class="form-label"></label>
                <input asp-for="SegmentInput.SegmentType" class="form-control" list="segment-type-options" />
                <datalist id="segment-type-options">
                    <option value="travel"></option>
                    <option value="lodging"></option>
                    <option value="activity"></option>
                    <option value="other"></option>
                </datalist>
                <span asp-validation-for="SegmentInput.SegmentType" class="text-danger"></span>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="SegmentInput.StartDateTimeUtc" class="form-label"></label>
                    <input asp-for="SegmentInput.StartDateTimeUtc" class="form-control" type="datetime-local" asp-format="{0:yyyy-MM-ddTHH:mm}" />
                    <span asp-validation-for="SegmentInput.StartDateTimeUtc" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="SegmentInput.EndDateTimeUtc" class="form-label"></label>
                    <input asp-for="SegmentInput.EndDateTimeUtc" class="form-control" type="datetime-local" asp-format="{0:yyyy-MM-ddTHH:mm}" />
                    <span asp-validation-for="SegmentInput.EndDateTimeUtc" class="text-danger"></span>
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="SegmentInput.Description" class="form-label"></label>
                <textarea asp-for="SegmentInput.Description" class="form-control" rows="3"></textarea>
                <span asp-validation-for="SegmentInput.Description" class="text-danger"></span>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save segment</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="entryFlyout" aria-labelledby="entryFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="entryFlyoutLabel" class="offcanvas-title">Add itinerary entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form method="post" asp-page-handler="SaveEntry" id="entry-form">
            <input asp-for="EntryInput.TripId" type="hidden" />
            <input asp-for="EntryInput.EntryId" type="hidden" />
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <div class="mb-3">
                <label asp-for="EntryInput.Title" class="form-label"></label>
                <input asp-for="EntryInput.Title" class="form-control" />
                <span asp-validation-for="EntryInput.Title" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Date" class="form-label"></label>
                <input asp-for="EntryInput.Date" class="form-control" type="date" asp-format="{0:yyyy-MM-dd}" />
                <span asp-validation-for="EntryInput.Date" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Category" class="form-label"></label>
                <input asp-for="EntryInput.Category" class="form-control" />
                <span asp-validation-for="EntryInput.Category" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Details" class="form-label"></label>
                <textarea asp-for="EntryInput.Details" class="form-control" rows="4"></textarea>
                <span asp-validation-for="EntryInput.Details" class="text-danger"></span>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save entry</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
