@page "{tripId?}"
@model MX.TravelItinerary.Web.Pages.Trips.DetailsModel
@using System.Linq
@using MX.TravelItinerary.Web.Pages.Shared.FormControls
@{
    ViewData["Title"] = "Trip Timeline";
    var trip = Model.TripDetails?.Trip;
    var tripSlug = string.IsNullOrWhiteSpace(trip?.Slug) ? null : trip.Slug;
    var tripId = trip?.TripId ?? Model.TripId;
    var tripStartDateValue = trip?.StartDate?.ToString("yyyy-MM-dd");
    var tripEndDateValue = trip?.EndDate?.ToString("yyyy-MM-dd");
}

<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <div>
        <p class="text-uppercase text-muted small mb-1">Trip Timeline</p>
        <h1 class="mb-1">@trip?.Name</h1>
        <div class="text-muted">
            @if (trip?.StartDate is not null || trip?.EndDate is not null)
            {
                <span>@trip?.StartDate?.ToString("MMM dd, yyyy")</span>
                {
                    <span> – @trip?.EndDate?.ToString("MMM dd, yyyy")</span>
                }
            }
            else
            {
                <span>Dates coming soon</span>
            }
        </div>
    </div>
    <div class="d-flex flex-wrap gap-2 justify-content-end">
        <a class="btn btn-outline-primary"
            asp-page="/Trips/RouteMap"
            asp-route-tripId="@(tripSlug is null ? tripId : null)"
            asp-route-tripSlug="@tripSlug">
            Route map
        </a>
        <a class="btn btn-outline-primary"
            asp-page="/Trips/CostSummary"
            asp-route-tripId="@(tripSlug is null ? tripId : null)"
            asp-route-tripSlug="@tripSlug">
            Cost summary
        </a>
        <a class="btn btn-outline-secondary" href="/trips">Back to Trips</a>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
{
    <div class="alert alert-success" role="alert">
        @Model.StatusMessage
    </div>
}

@if (Model.TripDetails is null)
{
    <div class="alert alert-warning">Trip could not be loaded.</div>
}
else
{
    var timelineModel = Model.GetTimelineDisplayModel();
    if (timelineModel is not null)
    {
        <partial name="~/Pages/Shared/_TripTimeline.cshtml" model="timelineModel" />
    }
}

<div class="fab-container">
    <button type="button" class="btn btn-primary rounded-circle fab-main" aria-label="Add timeline entry"
        data-fab-open-entry>
        <span class="fab-icon">+</span>
    </button>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="entryFlyout" aria-labelledby="entryFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="entryFlyoutLabel" class="offcanvas-title">Add itinerary entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form method="post" asp-page-handler="SaveEntry" id="entry-form">
            <input asp-for="EntryInput.TripId" type="hidden" />
            <input asp-for="EntryInput.EntryId" type="hidden" />
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <div class="mb-3">
                <label asp-for="EntryInput.Title" class="form-label"></label>
                <input asp-for="EntryInput.Title" class="form-control" />
                <span asp-validation-for="EntryInput.Title" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.ItemType" class="form-label"></label>
                <select asp-for="EntryInput.ItemType" class="form-select" asp-items="Model.EntryTypeOptions"></select>
                <span asp-validation-for="EntryInput.ItemType" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Date" class="form-label"></label>
                <input asp-for="EntryInput.Date" class="form-control" type="date" asp-format="{0:yyyy-MM-dd}"
                    min="@tripStartDateValue" max="@tripEndDateValue" />
                <span asp-validation-for="EntryInput.Date" class="text-danger"></span>
            </div>

            <div class="form-check form-switch mb-3">
                <input asp-for="EntryInput.IsMultiDay" class="form-check-input" type="checkbox" value="true"
                    data-entry-multi-day-toggle />
                <label asp-for="EntryInput.IsMultiDay" class="form-check-label"></label>
            </div>

            <div class="mb-3 d-none" data-entry-end-date>
                <label asp-for="EntryInput.EndDate" class="form-label"></label>
                <input asp-for="EntryInput.EndDate" class="form-control" type="date" asp-format="{0:yyyy-MM-dd}"
                    min="@tripStartDateValue" max="@tripEndDateValue" />
                <span asp-validation-for="EntryInput.EndDate" class="text-danger"></span>
            </div>

            <div data-entry-google-place-container>
                @{
                    var placePickerModel = new GooglePlacePickerModel(
                        Html.IdFor(m => m.EntryInput.GooglePlaceId).ToString(),
                        Html.NameFor(m => m.EntryInput.GooglePlaceId).ToString(),
                        "Google Place ID",
                        Model.EntryInput.GooglePlaceId,
                        Model.IsGoogleMapsConfigured);
                }
                <partial name="~/Pages/Shared/FormControls/_GooglePlacePicker.cshtml" model="@placePickerModel" />
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Details" class="form-label"></label>
                <textarea asp-for="EntryInput.Details" class="form-control" rows="4"></textarea>
                <span asp-validation-for="EntryInput.Details" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <div class="text-muted text-uppercase small">Category metadata</div>
                <div class="form-text">Additional fields appear when you pick travel, flight, or stay entry types.</div>
            </div>

            <div class="entry-metadata-section d-none" data-entry-metadata-section="travel">
                <h6 class="text-muted text-uppercase small mb-3">Travel locations</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        @{
                            var departurePicker = new GooglePlacePickerModel(
                                Html.IdFor(m => m.EntryInput.TravelSegment.DeparturePlaceId).ToString(),
                                Html.NameFor(m => m.EntryInput.TravelSegment.DeparturePlaceId).ToString(),
                                "Departure location",
                                Model.EntryInput.TravelSegment.DeparturePlaceId,
                                Model.IsGoogleMapsConfigured);
                        }
                        <partial name="~/Pages/Shared/FormControls/_GooglePlacePicker.cshtml" model="@departurePicker" />
                    </div>
                    <div class="col-md-6">
                        @{
                            var arrivalPicker = new GooglePlacePickerModel(
                                Html.IdFor(m => m.EntryInput.TravelSegment.ArrivalPlaceId).ToString(),
                                Html.NameFor(m => m.EntryInput.TravelSegment.ArrivalPlaceId).ToString(),
                                "Arrival location",
                                Model.EntryInput.TravelSegment.ArrivalPlaceId,
                                Model.IsGoogleMapsConfigured);
                        }
                        <partial name="~/Pages/Shared/FormControls/_GooglePlacePicker.cshtml" model="@arrivalPicker" />
                    </div>
                </div>
            </div>

            <div class="entry-metadata-section d-none" data-entry-metadata-section="flight">
                <h6 class="text-muted text-uppercase small mb-3">Flight snapshot</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="EntryInput.FlightMetadata.Airline" class="form-label"></label>
                        <input asp-for="EntryInput.FlightMetadata.Airline" class="form-control" />
                        <span asp-validation-for="EntryInput.FlightMetadata.Airline" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="EntryInput.FlightMetadata.FlightNumber" class="form-label"></label>
                        <input asp-for="EntryInput.FlightMetadata.FlightNumber" class="form-control" />
                        <span asp-validation-for="EntryInput.FlightMetadata.FlightNumber" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="EntryInput.FlightMetadata.DepartureAirport" class="form-label"></label>
                        <input asp-for="EntryInput.FlightMetadata.DepartureAirport" class="form-control" />
                        <span asp-validation-for="EntryInput.FlightMetadata.DepartureAirport"
                            class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="EntryInput.FlightMetadata.DepartureTime" class="form-label"></label>
                        <input asp-for="EntryInput.FlightMetadata.DepartureTime" class="form-control"
                            placeholder="e.g. 09:35 local" />
                        <span asp-validation-for="EntryInput.FlightMetadata.DepartureTime" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="EntryInput.FlightMetadata.ArrivalAirport" class="form-label"></label>
                        <input asp-for="EntryInput.FlightMetadata.ArrivalAirport" class="form-control" />
                        <span asp-validation-for="EntryInput.FlightMetadata.ArrivalAirport" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="EntryInput.FlightMetadata.ArrivalTime" class="form-label"></label>
                        <input asp-for="EntryInput.FlightMetadata.ArrivalTime" class="form-control"
                            placeholder="e.g. 18:20 local" />
                        <span asp-validation-for="EntryInput.FlightMetadata.ArrivalTime" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="entry-metadata-section d-none" data-entry-metadata-section="stay">
                <h6 class="text-muted text-uppercase small mb-3">Stay snapshot</h6>
                <div class="row g-3">
                    <div class="col-12">
                        <label asp-for="EntryInput.StayMetadata.PropertyName" class="form-label"></label>
                        <input asp-for="EntryInput.StayMetadata.PropertyName" class="form-control" />
                        <span asp-validation-for="EntryInput.StayMetadata.PropertyName" class="text-danger"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="EntryInput.StayMetadata.PropertyLink" class="form-label"></label>
                        <input asp-for="EntryInput.StayMetadata.PropertyLink" class="form-control" type="url"
                            placeholder="https://" />
                        <span asp-validation-for="EntryInput.StayMetadata.PropertyLink" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save entry</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="googlePlacePickerModal" tabindex="-1" aria-labelledby="googlePlacePickerModalLabel"
    aria-hidden="true" data-google-place-modal
    data-google-place-enabled="@(Model.IsGoogleMapsConfigured ? "true" : "false")">
    <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="googlePlacePickerModalLabel" class="modal-title">Find a place</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="googlePlacePickerSearch" class="form-label">Search Google Maps Places</label>
                    <div class="input-group">
                        <input type="text" id="googlePlacePickerSearch" class="form-control"
                            placeholder="Start typing a place or address" data-place-picker-search autocomplete="off"
                            spellcheck="false">
                        <button type="button" class="btn btn-outline-secondary" data-place-picker-clear>Clear</button>
                    </div>
                    <div class="form-text" data-place-picker-hint>Look up hotels, airports, landmarks, or entire
                        neighborhoods.</div>
                </div>
                <div class="row g-3 align-items-stretch">
                    <div class="col-lg-7">
                        <div class="place-picker-map" data-place-picker-map>
                            <div class="place-picker-map-placeholder">Map preview loads after the Places API is ready.</div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="place-picker-preview" data-place-picker-preview>
                            <div class="text-muted text-uppercase small mb-2">Selection</div>
                            <div class="place-picker-selection-name" data-place-picker-name>Search to preview a place.
                            </div>
                            <div class="place-picker-selection-address text-muted" data-place-picker-address>Full
                                address will appear here.</div>
                            <div class="mt-3">
                                <div class="text-muted text-uppercase small">Place ID</div>
                                <code class="place-picker-selection-id" data-place-picker-id>—</code>
                            </div>
                            <div class="mt-3 text-muted small" data-place-picker-status>Search to pick a place.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" data-place-picker-submit disabled>Use this place</button>
            </div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="bookingFlyout" aria-labelledby="bookingFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="bookingFlyoutLabel" class="offcanvas-title">Add booking confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form method="post" asp-page-handler="SaveBooking" id="booking-form">
            <input asp-for="BookingInput.TripId" type="hidden" />
            <input asp-for="BookingInput.BookingId" type="hidden" />
            <input asp-for="BookingInput.EntryId" type="hidden" />
            <input asp-for="BookingInput.ItemType" type="hidden" />
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <div class="mb-3">
                <label class="form-label">Category</label>
                <div id="bookingCategoryDisplay" class="form-control-plaintext fw-semibold">—</div>
                <div class="form-text">Bookings inherit their category from the linked itinerary entry.</div>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.Vendor" class="form-label"></label>
                <input asp-for="BookingInput.Vendor" class="form-control" />
                <span asp-validation-for="BookingInput.Vendor" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.Reference" class="form-label"></label>
                <input asp-for="BookingInput.Reference" class="form-control" />
                <span asp-validation-for="BookingInput.Reference" class="text-danger"></span>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="BookingInput.Cost" class="form-label"></label>
                    <input asp-for="BookingInput.Cost" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="BookingInput.Cost" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="BookingInput.Currency" class="form-label"></label>
                    <input asp-for="BookingInput.Currency" class="form-control" maxlength="3"
                        style="text-transform:uppercase;" data-currency-input />
                    <span asp-validation-for="BookingInput.Currency" class="text-danger"></span>
                    <div class="form-text">Use ISO codes (USD, EUR) or pick Rewards Points for loyalty bookings.</div>
                </div>
            </div>

            <div class="form-check mb-3 mt-2">
                <input asp-for="BookingInput.IsRefundable" class="form-check-input" type="checkbox" value="true" />
                <label asp-for="BookingInput.IsRefundable" class="form-check-label"></label>
            </div>

            @{
                var showRefundableSection = Model.BookingInput.IsRefundable;
                var refundableSectionClasses = showRefundableSection ? "mb-3" : "mb-3 d-none";
            }
            <div class="@refundableSectionClasses" data-booking-refundable-section>
                <label asp-for="BookingInput.CancellationByDate" class="form-label"></label>
                <input asp-for="BookingInput.CancellationByDate" class="form-control" type="date"
                    asp-format="{0:yyyy-MM-dd}" />
                <span asp-validation-for="BookingInput.CancellationByDate" class="text-danger"></span>
                <div class="form-text">Let yourself know when the refund window closes.</div>
            </div>

            <div class="form-check mb-3">
                <input asp-for="BookingInput.IsPaid" class="form-check-input" type="checkbox" value="true" />
                <label asp-for="BookingInput.IsPaid" class="form-check-label"></label>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.CancellationPolicy" class="form-label"></label>
                <textarea asp-for="BookingInput.CancellationPolicy" class="form-control" rows="2"></textarea>
                <span asp-validation-for="BookingInput.CancellationPolicy" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.ConfirmationUrl" class="form-label"></label>
                <input asp-for="BookingInput.ConfirmationUrl" class="form-control" type="url" placeholder="https://" />
                <span asp-validation-for="BookingInput.ConfirmationUrl" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.ConfirmationDetails" class="form-label"></label>
                <textarea asp-for="BookingInput.ConfirmationDetails" class="form-control" rows="4"></textarea>
                <span asp-validation-for="BookingInput.ConfirmationDetails" class="text-danger"></span>
            </div>

            @{
                var showBookingStaySection = Model.BookingInput.ItemType is
                MX.TravelItinerary.Web.Data.Models.TimelineItemType.Hotel
                or MX.TravelItinerary.Web.Data.Models.TimelineItemType.Flat
                or MX.TravelItinerary.Web.Data.Models.TimelineItemType.House;
                var staySectionClasses = showBookingStaySection ? "mb-3 pt-3 border-top" : "mb-3 pt-3 border-top d-none";
            }
            <div class="@staySectionClasses" data-booking-stay-section>
                <div class="d-flex justify-content-between flex-wrap align-items-center mb-2">
                    <div>
                        <div class="text-muted text-uppercase small">Stay metadata</div>
                        <div class="form-text">Optional details that appear on the booking timeline.</div>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="BookingInput.StayCheckInTime" class="form-label"></label>
                        <input asp-for="BookingInput.StayCheckInTime" class="form-control"
                            placeholder="e.g. After 3 PM" />
                        <span asp-validation-for="BookingInput.StayCheckInTime" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="BookingInput.StayCheckOutTime" class="form-label"></label>
                        <input asp-for="BookingInput.StayCheckOutTime" class="form-control"
                            placeholder="e.g. Before 11 AM" />
                        <span asp-validation-for="BookingInput.StayCheckOutTime" class="text-danger"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="BookingInput.StayRoomType" class="form-label"></label>
                        <input asp-for="BookingInput.StayRoomType" class="form-control"
                            placeholder="e.g. Deluxe king with lounge access" />
                        <span asp-validation-for="BookingInput.StayRoomType" class="text-danger"></span>
                    </div>
                    <div class="col-12">
                        <label asp-for="BookingInput.StayIncludes" class="form-label"></label>
                        <select asp-for="BookingInput.StayIncludes" asp-items="Model.BookingInclusionOptions"
                            class="form-select" multiple size="4"></select>
                        <span asp-validation-for="BookingInput.StayIncludes" class="text-danger"></span>
                        <div class="form-text">Select all features included with this stay.</div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save booking</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="bookingDetailFlyout" aria-labelledby="bookingDetailFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="bookingDetailFlyoutLabel" class="offcanvas-title">Booking details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="mb-3">
            <div class="text-muted text-uppercase small">Linked to</div>
            <div class="fw-semibold" data-booking-detail="parent">—</div>
        </div>
        <dl class="row booking-detail-list">
            <dt class="col-sm-4">Type</dt>
            <dd class="col-sm-8" data-booking-detail="type">—</dd>
            <dt class="col-sm-4">Vendor</dt>
            <dd class="col-sm-8" data-booking-detail="vendor">—</dd>
            <dt class="col-sm-4">Confirmation #</dt>
            <dd class="col-sm-8" data-booking-detail="reference">—</dd>
            <dt class="col-sm-4">Cost</dt>
            <dd class="col-sm-8" data-booking-detail="cost">—</dd>
            <dt class="col-sm-4">Refundable</dt>
            <dd class="col-sm-8" data-booking-detail="refundable">—</dd>
            <dt class="col-sm-4">Paid</dt>
            <dd class="col-sm-8 booking-detail-flag" data-booking-detail="paid">—</dd>
            <dt class="col-sm-4">Cancel by</dt>
            <dd class="col-sm-8" data-booking-detail="cancelby">—</dd>
            <dt class="col-sm-4">Cancellation</dt>
            <dd class="col-sm-8" data-booking-detail="cancellation">—</dd>
            <dt class="col-sm-4">Manage booking</dt>
            <dd class="col-sm-8">
                <a href="#" class="booking-link d-none" target="_blank" rel="noopener" data-booking-link>Open booking
                    link</a>
                <span data-booking-link-placeholder>—</span>
            </dd>
        </dl>
        <div class="mb-4 d-none" data-booking-detail-stay-section>
            <div class="text-muted text-uppercase small">Stay snapshot</div>
            <dl class="row booking-detail-list mb-0">
                <dt class="col-sm-4">Check-in</dt>
                <dd class="col-sm-8" data-booking-detail="checkin">—</dd>
                <dt class="col-sm-4">Check-out</dt>
                <dd class="col-sm-8" data-booking-detail="checkout">—</dd>
                <dt class="col-sm-4">Room</dt>
                <dd class="col-sm-8" data-booking-detail="room">—</dd>
                <dt class="col-sm-4">Includes</dt>
                <dd class="col-sm-8" data-booking-detail="includes">—</dd>
            </dl>
        </div>
        <div class="mb-4">
            <div class="text-muted text-uppercase small">Confirmation details</div>
            <div class="booking-detail-notes" data-booking-detail="notes">—</div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-primary" id="bookingDetailEditButton">Edit booking</button>
            <form method="post" asp-page-handler="DeleteBooking" id="bookingDetailDeleteForm" class="d-inline">
                <input type="hidden" name="tripId" value="@Model.TripDetails?.Trip.TripId" />
                <input type="hidden" name="bookingId" value="" />
                <button type="submit" class="btn btn-outline-danger">Delete booking</button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    @if (Model.IsGoogleMapsConfigured)
    {
        <script>
            window.travelPlacePickerReady = function () {
                document.dispatchEvent(new CustomEvent('travel-place-picker:loader-ready'));
            };
        </script>
        <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=@Model.GoogleMapsApiKey&libraries=places&callback=travelPlacePickerReady"></script>
    }
}