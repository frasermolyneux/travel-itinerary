@page "{tripId}"
@model MX.TravelItinerary.Web.Pages.Trips.DetailsModel
@using System.Linq
@{
    ViewData["Title"] = "Trip Timeline";
    var trip = Model.TripDetails?.Trip;
    var tripStartDateValue = trip?.StartDate?.ToString("yyyy-MM-dd");
    var tripEndDateValue = trip?.EndDate?.ToString("yyyy-MM-dd");
}

<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <div>
        <p class="text-uppercase text-muted small mb-1">Trip Timeline</p>
        <h1 class="mb-1">@trip?.Name</h1>
        <div class="text-muted">
            @if (trip?.StartDate is not null || trip?.EndDate is not null)
            {
                <span>@trip?.StartDate?.ToString("MMM dd, yyyy")</span>
                {
                    <span> – @trip?.EndDate?.ToString("MMM dd, yyyy")</span>
                }
            }
            else
            {
                <span>Dates coming soon</span>
            }
        </div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" asp-page="./Index">Back to Trips</a>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
{
    <div class="alert alert-success" role="alert">
        @Model.StatusMessage
    </div>
}

@if (Model.TripDetails is null)
{
    <div class="alert alert-warning">Trip could not be loaded.</div>
}
else
{
    var hasPlannedContent = Model.Timeline.Spans.Any()
    || Model.Timeline.Days.Any(day => day.Entries.Count > 0);
    if (!hasPlannedContent)
    {
        <div class="alert alert-info">No itinerary entries yet. Use the quick actions to start planning this trip.</div>
    }

    <div class="timeline-grid">
        @foreach (var day in Model.Timeline.Days)
        {
            <div class="timeline-axis" style="grid-row:@day.RowLine;">
                <div class="timeline-axis-dot"></div>
                <div>
                    <div class="timeline-day-label">@day.Date.ToString("MMM dd")</div>
                    <div class="timeline-day-weekday">@day.Date.ToString("dddd")</div>
                </div>
            </div>
            <div class="timeline-content" style="grid-row:@day.RowLine;">
                @if (day.Entries.Count == 0)
                {
                    <div class="timeline-empty text-muted">No entries for this day.</div>
                }
                else
                {
                    @foreach (var entry in day.Entries)
                    {
                        var entryBooking = Model.GetBookingForEntry(entry.EntryId);
                        var entryTypeToken = entry.ItemType.ToCssToken();
                        <div class="timeline-item" data-timeline-item data-item-type="entry" data-item-id="@entry.EntryId">
                            <div class="timeline-item-body">
                                <div class="timeline-item-heading">
                                    <span class="timeline-item-icon bi @entry.ItemType.GetIconClass() segment-type-@entryTypeToken"
                                        aria-hidden="true"></span>
                                    <span class="timeline-item-title">@entry</span>
                                    @if (entryBooking is not null)
                                    {
                                        <span class="booking-indicator" title="Booking attached">&#128206;</span>
                                    }
                                </div>
                            </div>
                            <div class="timeline-actions">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" data-edit-type="entry"
                                    data-entry-id="@entry.EntryId" data-entry-title="@entry.Title"
                                    data-entry-date="@(entry.Date?.ToString("yyyy-MM-dd") ?? string.Empty)"
                                    data-entry-end="@(entry.EndDate?.ToString("yyyy-MM-dd") ?? string.Empty)"
                                    data-entry-type="@entry.ItemType"
                                    data-entry-is-multi-day="@(entry.IsMultiDay.ToString().ToLowerInvariant())"
                                    data-entry-details="@(entry.Details ?? string.Empty)">
                                    Edit
                                </button>
                                <form method="post" asp-page-handler="DeleteEntry" class="d-inline">
                                    <input type="hidden" name="entryId" value="@entry.EntryId" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                                @if (entryBooking is null)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="add"
                                        data-parent-type="entry" data-entry-id="@entry.EntryId" data-entry-title="@entry.Title"
                                        data-entry-type="@entry.ItemType" data-entry-type-label="@entry.ItemType.GetDisplayName()">
                                        Add booking
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="view"
                                        data-booking-id="@entryBooking.BookingId" data-booking-type="@entryBooking.ItemType"
                                        data-booking-type-label="@entryBooking.ItemType.GetDisplayName()"
                                        data-booking-vendor="@(entryBooking.Vendor ?? string.Empty)"
                                        data-booking-reference="@(entryBooking.Reference ?? string.Empty)"
                                        data-booking-cost="@(entryBooking.Cost?.ToString("0.##") ?? string.Empty)"
                                        data-booking-currency="@(entryBooking.Currency ?? string.Empty)"
                                        data-booking-refundable="@(entryBooking.IsRefundable?.ToString().ToLowerInvariant() ?? string.Empty)"
                                        data-booking-cancellation="@(entryBooking.CancellationPolicy ?? string.Empty)"
                                        data-booking-details="@(entryBooking.ConfirmationDetailsJson ?? string.Empty)"
                                        data-booking-parent-label="@entry" data-booking-parent-type="entry"
                                        data-parent-entry="@entry.EntryId">
                                        View booking
                                    </button>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        }

        @foreach (var block in Model.Timeline.Spans)
        {
            var segmentType = block.Entry.ItemType.ToCssToken();
            var entryBooking = Model.GetBookingForEntry(block.Entry.EntryId);
            <div class="timeline-segment"
                style="grid-row:@block.RowStart / @block.RowEnd; --lane-index:@block.LaneIndex; --lane-count:@block.LaneCount;"
                data-segment-type="@segmentType">
                <div class="timeline-segment-span" aria-hidden="true"></div>
                <div class="timeline-item timeline-item--segment segment-type-@segmentType" data-timeline-item
                    data-item-type="entry" data-item-id="@block.Entry.EntryId">
                    <div class="timeline-item-body">
                        <div class="timeline-item-heading">
                            <span class="timeline-item-icon bi @block.Entry.ItemType.GetIconClass() segment-type-@segmentType"
                                aria-hidden="true"></span>
                            <span class="timeline-item-title">@block.Entry</span>
                            @if (entryBooking is not null)
                            {
                                <span class="booking-indicator" title="Booking attached">&#128206;</span>
                            }
                        </div>
                        <div class="small text-muted">@block.StartDate.ToString("MMM dd") – @block.EndDate.ToString("MMM dd")
                        </div>
                    </div>
                    <div class="timeline-actions">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" data-edit-type="entry"
                            data-entry-id="@block.Entry.EntryId" data-entry-title="@block.Entry.Title"
                            data-entry-date="@(block.Entry.Date?.ToString("yyyy-MM-dd") ?? string.Empty)"
                            data-entry-end="@(block.Entry.EndDate?.ToString("yyyy-MM-dd") ?? string.Empty)"
                            data-entry-type="@block.Entry.ItemType"
                            data-entry-is-multi-day="@(block.Entry.IsMultiDay.ToString().ToLowerInvariant())"
                            data-entry-details="@(block.Entry.Details ?? string.Empty)">
                            Edit
                        </button>
                        <form method="post" asp-page-handler="DeleteEntry" class="d-inline">
                            <input type="hidden" name="entryId" value="@block.Entry.EntryId" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                        @if (entryBooking is null)
                        {
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="add"
                                data-parent-type="entry" data-entry-id="@block.Entry.EntryId"
                                data-entry-title="@(block.Entry.Title ?? block.Entry.ItemType.GetDisplayName())"
                                data-entry-type="@block.Entry.ItemType"
                                data-entry-type-label="@block.Entry.ItemType.GetDisplayName()">
                                Add booking
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-booking-action="view"
                                data-booking-id="@entryBooking.BookingId" data-booking-type="@entryBooking.ItemType"
                                data-booking-type-label="@entryBooking.ItemType.GetDisplayName()"
                                data-booking-vendor="@(entryBooking.Vendor ?? string.Empty)"
                                data-booking-reference="@(entryBooking.Reference ?? string.Empty)"
                                data-booking-cost="@(entryBooking.Cost?.ToString("0.##") ?? string.Empty)"
                                data-booking-currency="@(entryBooking.Currency ?? string.Empty)"
                                data-booking-refundable="@(entryBooking.IsRefundable?.ToString().ToLowerInvariant() ?? string.Empty)"
                                data-booking-cancellation="@(entryBooking.CancellationPolicy ?? string.Empty)"
                                data-booking-details="@(entryBooking.ConfirmationDetailsJson ?? string.Empty)"
                                data-booking-parent-label="@block.Entry" data-booking-parent-type="entry"
                                data-parent-entry="@block.Entry.EntryId">
                                View booking
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

<div class="fab-container">
    <button type="button" class="btn btn-primary rounded-circle fab-main" aria-label="Add timeline entry"
        data-fab-open-entry>
        <span class="fab-icon">+</span>
    </button>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="entryFlyout" aria-labelledby="entryFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="entryFlyoutLabel" class="offcanvas-title">Add itinerary entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form method="post" asp-page-handler="SaveEntry" id="entry-form">
            <input asp-for="EntryInput.TripId" type="hidden" />
            <input asp-for="EntryInput.EntryId" type="hidden" />
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <div class="mb-3">
                <label asp-for="EntryInput.Title" class="form-label"></label>
                <input asp-for="EntryInput.Title" class="form-control" />
                <span asp-validation-for="EntryInput.Title" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Date" class="form-label"></label>
                <input asp-for="EntryInput.Date" class="form-control" type="date" asp-format="{0:yyyy-MM-dd}"
                    min="@tripStartDateValue" max="@tripEndDateValue" />
                <span asp-validation-for="EntryInput.Date" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.ItemType" class="form-label"></label>
                <select asp-for="EntryInput.ItemType" class="form-select" asp-items="Model.EntryTypeOptions"></select>
                <span asp-validation-for="EntryInput.ItemType" class="text-danger"></span>
            </div>

            <div class="form-check form-switch mb-3">
                <input asp-for="EntryInput.IsMultiDay" class="form-check-input" type="checkbox" value="true"
                    data-entry-multi-day-toggle />
                <label asp-for="EntryInput.IsMultiDay" class="form-check-label"></label>
            </div>

            <div class="mb-3 d-none" data-entry-end-date>
                <label asp-for="EntryInput.EndDate" class="form-label"></label>
                <input asp-for="EntryInput.EndDate" class="form-control" type="date" asp-format="{0:yyyy-MM-dd}"
                    min="@tripStartDateValue" max="@tripEndDateValue" />
                <span asp-validation-for="EntryInput.EndDate" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="EntryInput.Details" class="form-label"></label>
                <textarea asp-for="EntryInput.Details" class="form-control" rows="4"></textarea>
                <span asp-validation-for="EntryInput.Details" class="text-danger"></span>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save entry</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="bookingFlyout" aria-labelledby="bookingFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="bookingFlyoutLabel" class="offcanvas-title">Add booking confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form method="post" asp-page-handler="SaveBooking" id="booking-form">
            <input asp-for="BookingInput.TripId" type="hidden" />
            <input asp-for="BookingInput.BookingId" type="hidden" />
            <input asp-for="BookingInput.EntryId" type="hidden" />
            <div asp-validation-summary="All" class="text-danger mb-3"></div>

            <div class="mb-3">
                <label class="form-label">Category</label>
                <div id="bookingCategoryDisplay" class="form-control-plaintext fw-semibold">—</div>
                <div class="form-text">Bookings inherit their category from the linked itinerary entry.</div>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.Vendor" class="form-label"></label>
                <input asp-for="BookingInput.Vendor" class="form-control" />
                <span asp-validation-for="BookingInput.Vendor" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.Reference" class="form-label"></label>
                <input asp-for="BookingInput.Reference" class="form-control" />
                <span asp-validation-for="BookingInput.Reference" class="text-danger"></span>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="BookingInput.Cost" class="form-label"></label>
                    <input asp-for="BookingInput.Cost" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="BookingInput.Cost" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="BookingInput.Currency" class="form-label"></label>
                    <input asp-for="BookingInput.Currency" class="form-control" maxlength="3"
                        style="text-transform:uppercase;" />
                    <span asp-validation-for="BookingInput.Currency" class="text-danger"></span>
                </div>
            </div>

            <div class="form-check mb-3 mt-2">
                <input asp-for="BookingInput.IsRefundable" class="form-check-input" type="checkbox" value="true" />
                <label asp-for="BookingInput.IsRefundable" class="form-check-label"></label>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.CancellationPolicy" class="form-label"></label>
                <textarea asp-for="BookingInput.CancellationPolicy" class="form-control" rows="2"></textarea>
                <span asp-validation-for="BookingInput.CancellationPolicy" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="BookingInput.ConfirmationDetails" class="form-label"></label>
                <textarea asp-for="BookingInput.ConfirmationDetails" class="form-control" rows="4"></textarea>
                <span asp-validation-for="BookingInput.ConfirmationDetails" class="text-danger"></span>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save booking</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="bookingDetailFlyout" aria-labelledby="bookingDetailFlyoutLabel">
    <div class="offcanvas-header">
        <h5 id="bookingDetailFlyoutLabel" class="offcanvas-title">Booking details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="mb-3">
            <div class="text-muted text-uppercase small">Linked to</div>
            <div class="fw-semibold" data-booking-detail="parent">—</div>
        </div>
        <dl class="row booking-detail-list">
            <dt class="col-sm-4">Type</dt>
            <dd class="col-sm-8" data-booking-detail="type">—</dd>
            <dt class="col-sm-4">Vendor</dt>
            <dd class="col-sm-8" data-booking-detail="vendor">—</dd>
            <dt class="col-sm-4">Confirmation #</dt>
            <dd class="col-sm-8" data-booking-detail="reference">—</dd>
            <dt class="col-sm-4">Cost</dt>
            <dd class="col-sm-8" data-booking-detail="cost">—</dd>
            <dt class="col-sm-4">Refundable</dt>
            <dd class="col-sm-8" data-booking-detail="refundable">—</dd>
            <dt class="col-sm-4">Cancellation</dt>
            <dd class="col-sm-8" data-booking-detail="cancellation">—</dd>
        </dl>
        <div class="mb-4">
            <div class="text-muted text-uppercase small">Confirmation details</div>
            <div class="booking-detail-notes" data-booking-detail="notes">—</div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-primary" id="bookingDetailEditButton">Edit booking</button>
            <form method="post" asp-page-handler="DeleteBooking" id="bookingDetailDeleteForm" class="d-inline">
                <input type="hidden" name="tripId" value="@Model.TripDetails?.Trip.TripId" />
                <input type="hidden" name="bookingId" value="" />
                <button type="submit" class="btn btn-outline-danger">Delete booking</button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}